name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure linker (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          mkdir -p .cargo
          cat >> .cargo/config.toml <<EOF
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package (Unix)
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../kiro-gateway-${{ matrix.target }}.tar.gz kiro-gateway
          cd ../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kiro-gateway-${{ matrix.target }}
          path: kiro-gateway-${{ matrix.target }}.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.tar.gz
          generate_release_notes: true

  homebrew:
    name: Update Homebrew Formula
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag (e.g., v1.0.4 -> 1.0.4)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          # macOS Intel
          MACOS_INTEL_SHA=$(sha256sum artifacts/kiro-gateway-x86_64-apple-darwin/kiro-gateway-x86_64-apple-darwin.tar.gz | cut -d ' ' -f 1)
          echo "macos_intel_sha=$MACOS_INTEL_SHA" >> $GITHUB_OUTPUT
          echo "macOS Intel SHA256: $MACOS_INTEL_SHA"

          # macOS ARM
          MACOS_ARM_SHA=$(sha256sum artifacts/kiro-gateway-aarch64-apple-darwin/kiro-gateway-aarch64-apple-darwin.tar.gz | cut -d ' ' -f 1)
          echo "macos_arm_sha=$MACOS_ARM_SHA" >> $GITHUB_OUTPUT
          echo "macOS ARM SHA256: $MACOS_ARM_SHA"

          # Linux Intel
          LINUX_INTEL_SHA=$(sha256sum artifacts/kiro-gateway-x86_64-unknown-linux-gnu/kiro-gateway-x86_64-unknown-linux-gnu.tar.gz | cut -d ' ' -f 1)
          echo "linux_intel_sha=$LINUX_INTEL_SHA" >> $GITHUB_OUTPUT
          echo "Linux Intel SHA256: $LINUX_INTEL_SHA"

          # Linux ARM
          LINUX_ARM_SHA=$(sha256sum artifacts/kiro-gateway-aarch64-unknown-linux-gnu/kiro-gateway-aarch64-unknown-linux-gnu.tar.gz | cut -d ' ' -f 1)
          echo "linux_arm_sha=$LINUX_ARM_SHA" >> $GITHUB_OUTPUT
          echo "Linux ARM SHA256: $LINUX_ARM_SHA"

      - name: Generate Homebrew formula
        run: |
          cat > kiro-gateway.rb <<'FORMULA_EOF'
          class KiroGateway < Formula
            desc "Proxy gateway for Kiro API - OpenAI and Anthropic compatible"
            homepage "https://github.com/if414013/rkgw"
            version "${{ steps.version.outputs.version }}"
            license "AGPL-3.0"

            on_macos do
              on_intel do
                url "https://github.com/if414013/rkgw/releases/download/v#{version}/kiro-gateway-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.macos_intel_sha }}"
              end
              on_arm do
                url "https://github.com/if414013/rkgw/releases/download/v#{version}/kiro-gateway-aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.macos_arm_sha }}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/if414013/rkgw/releases/download/v#{version}/kiro-gateway-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_intel_sha }}"
              end
              on_arm do
                url "https://github.com/if414013/rkgw/releases/download/v#{version}/kiro-gateway-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_arm_sha }}"
              end
            end

            def install
              bin.install "kiro-gateway"
            end

            test do
              assert_match "kiro-gateway", shell_output("#{bin}/kiro-gateway --help 2>&1", 2)
            end
          end
          FORMULA_EOF

          echo "Generated formula:"
          cat kiro-gateway.rb

      - name: Push to Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone the tap repository
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/if414013/homebrew-tvps.git tap-repo

          # Copy the formula
          cp kiro-gateway.rb tap-repo/Formula/kiro-gateway.rb

          # Commit and push
          cd tap-repo
          git add Formula/kiro-gateway.rb
          git commit -m "Update kiro-gateway to ${{ steps.version.outputs.version }}"
          git push origin main
